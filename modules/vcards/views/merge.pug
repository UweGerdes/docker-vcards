//- merge.pug
mixin parts(value, parts)
  each part in parts
    if value[part]
      span(title=part)= value[part] + ' '

mixin types(types, name, index)
  if typeof types == 'string'
    input(type='hidden', id='value_' + name + index, name=name + index + '_type', value=types)
    span.type= ' (' + type(types) + ')'
  else
    each type, i in types
      input(type='hidden', id='value_' + name + index + i, name=name + index + '_type', value=type)
    span.type= ' (' + type(types).join(", ") + ')'


mixin list2(prop, other, name, id)
  - otherValues = []
  ul.values
    each item, i in prop
      li.values-item
        input(type='checkbox', name=id + i, value=item.value, checked, id=id + '_' + i)
        label(for=id + '_' + i)
          if fields[name].parts_order
            if !other || JSON.stringify(item) != JSON.stringify(other.value)
              label(for=id)
                each part in fields[name].parts_order
                  if item.value[part]
                    span(title=part)= item.value[part] + ' '
          else
            = item.value
          if item.type
            + types(item.type, id, i)

mixin choice2(prop, other, name, id)
  span.choice
    if prop.value && (!other || JSON.stringify(prop.value) != JSON.stringify(other.value))
      input(type='radio', name=name, value=prop.value, checked=!other, id=id)
      label(for=id)
        if fields[name].parts
          + parts(prop.value, fields[name].parts_order)
        else
          = prop.value

mixin value2(prop, other, name, id)
  if prop
    if fields[name].type == 'list'
      + list2(prop, other, name, id)
    else
      + choice2(prop, other, name, id)
  else
    | !{'&nbsp;'}

mixin field2(prop1, prop2, name)
  li.list-item
    div(id=name).fielddiv.label= fields[name].label + ":"
    div.itemvalue.i1
      + value2(prop1, null, name, name + '1')
    div.itemvalue.i2
      + value2(prop2, prop1, name, name + '2')

#mergeView.mergeView
  - var names1 = vcard.getFields()
  - var names2 = vcard2.getFields()
  form#merge.merge(method='POST', action='/vcards/save/' + id + '/' + id2)
    ul#fieldList.item-list
      each name in names1
        + field2(vcard.prop[name], vcard2.prop[name], name)
      each name in names2
        if (names1.indexOf(name) < 0)
          + field2(null, vcard2.prop[name], name)
    #submit.submit
      input.searchSubmit(type='submit', value='speichern')
